import os
import telebot
from telebot import types
import gspread
from datetime import datetime, timedelta
import json
import logging

# ================== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ==================
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# ================== –ü–û–õ–£–ß–ï–ù–ò–ï –ü–ï–†–ï–ú–ï–ù–ù–´–• –û–ö–†–£–ñ–ï–ù–ò–Ø ==================
# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.environ.get('BOT_TOKEN')
if not BOT_TOKEN:
    logger.error("‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
    exit(1)

bot = telebot.TeleBot(BOT_TOKEN)

# ================== –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö GOOGLE SHEETS ==================
def init_google_sheets():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Sheets –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º JSON —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
        credentials_json = os.environ.get('GOOGLE_CREDENTIALS_JSON')
        
        if not credentials_json:
            logger.error("‚ùå GOOGLE_CREDENTIALS_JSON –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!")
            return None
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSON —Å—Ç—Ä–æ–∫—É –≤ —Å–ª–æ–≤–∞—Ä—å
        credentials_dict = json.loads(credentials_json)
        
        # –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è —Å –ø–æ–º–æ—â—å—é —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–ª–æ–≤–∞—Ä—è
        import gspread
        from google.oauth2.service_account import Credentials
        
        scope = [
            'https://spreadsheets.google.com/feeds',
            'https://www.googleapis.com/auth/drive',
            'https://www.googleapis.com/auth/spreadsheets'
        ]
        
        credentials = Credentials.from_service_account_info(credentials_dict, scopes=scope)
        gc = gspread.authorize(credentials)
        
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É (–Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        spreadsheet_name = os.environ.get('SPREADSHEET_NAME', 'google-api-sheets-incident')
        wks = gc.open(spreadsheet_name)
        
        logger.info(f"‚úÖ –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets: {spreadsheet_name}")
        return wks
        
    except json.JSONDecodeError as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON: {e}")
        return None
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets: {e}")
        return None

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Google Sheets
wks = init_google_sheets()
if not wks:
    logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Google Sheets. –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
    exit(1)

# ================== –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î (–ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ==================
# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_data = {}

# –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∏
write_lock = False

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ª–∏—Å—Ç–∞ (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–∏ —Å–º–µ–Ω–µ –º–µ—Å—è—Ü–∞)
def get_current_sheet():
    current_month_year = datetime.now().strftime("%Y-%m")  # –§–æ—Ä–º–∞—Ç: 2024-01

    try:
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ª–∏—Å—Ç —Å —Ç–µ–∫—É—â–∏–º –º–µ—Å—è—Ü–µ–º
        sheet = wks.worksheet(current_month_year)
        logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–∏—Å—Ç: {current_month_year}")
    except gspread.exceptions.WorksheetNotFound:
        # –ï—Å–ª–∏ –ª–∏—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
        logger.info(f"–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç: {current_month_year}")
        sheet = wks.add_worksheet(title=current_month_year, rows=1000, cols=20)

        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
        headers = ["–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è", "–†–∞–π–æ–Ω", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è", "–¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è"]
        sheet.append_row(headers)

        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        setup_statistics_headers(sheet)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª–∏—Å—Ç–∞: {e}")
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –ª–∏—Å—Ç –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        sheet = wks.get_worksheet(0)

    return sheet

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É
def safe_append_row(sheet, row_data):
    global write_lock
    while write_lock:
        import time
        time.sleep(0.1)
    
    write_lock = True
    try:
        sheet.append_row(row_data, value_input_option='USER_ENTERED')
        logger.info(f"–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω—ã: {row_data[:3]}")
        return True
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
        return False
    finally:
        write_lock = False

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
def setup_statistics_headers(sheet):
    try:
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –Ω–µ–¥–µ–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–Ω–∞—á–∏–Ω–∞—è —Å –∫–æ–ª–æ–Ω–∫–∏ F)
        stats_headers = [
            "–ù–µ–¥–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
            "–ü–µ—Ä–∏–æ–¥",
            "–í—Å–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π",
            "–î–æ—Ä–æ–≥–∏",
            "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç",
            "–ì–æ—Å—É—Å–ª—É–≥–∏",
            "–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ",
            "–ò–Ω–æ–µ",
            "–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ",
            "–°–æ—Ü. –∑–∞—â–∏—Ç–∞",
            "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
            "–ñ–ö–•",
            "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞",
            "–°–í–û, –º–æ–±–∏–ª–∏–∑–∞—Ü–∏—è",
            "–ú—É—Å–æ—Ä",
            "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å",
            "–°/—Ö –∏ –æ—Ö–æ—Ç–∞",
            "–°–≤—è–∑—å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã",
            "–ö—É–ª—å—Ç—É—Ä–∞",
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞",
            "–≠–∫–æ–ª–æ–≥–∏—è, –Ω–µ–¥—Ä–∞, –ª–µ—Å—Ö–æ–∑",
            "–§–∏–∑. –∫—É–ª—å—Ç—É—Ä–∞ –∏ —Å–ø–æ—Ä—Ç",
            "–¢—Ä—É–¥ –∏ –∑–∞–Ω—è—Ç–æ—Å—Ç—å",
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ",
            "–û–±—â- –ø–æ–ª–∏—Ç.–≤–æ–ø—Ä–æ—Å—ã",
            "–¢—É—Ä–∏–∑–º",
            "–ü–ª–∞–Ω–µ—Ä–∫–∞"
        ]

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        for i, header in enumerate(stats_headers):
            sheet.update_cell(1, 6 + i, header)
        logger.info("–ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
def get_main_data(sheet):
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–ª–æ–Ω–æ–∫ A-D (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
        data = sheet.get('A:D')
        return data if data else []
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: {e}")
        return []

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
def update_statistics(sheet):
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∫–æ–ª–æ–Ω–∫–∏ A-D)
        main_data = get_main_data(sheet)

        if len(main_data) <= 1:  # –¢–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–ª–∏ –ø—É—Å—Ç–æ
            return

        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        data_rows = main_data[1:]

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—å–Ω—É—é –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É
        current_week = get_current_week_range()
        week_data = []

        # –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
        for row in data_rows:
            if len(row) >= 1 and row[0]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –¥–∞—Ç–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ A
                try:
                    row_date = datetime.strptime(row[0], "%Y-%m-%d %H:%M:%S")
                    if is_date_in_week_range(row_date, current_week):
                        week_data.append(row)
                except ValueError:
                    continue

        # –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        stats = {
            "–í—Å–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π": len(week_data),
            "–î–æ—Ä–æ–≥–∏": 0,
            "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç": 0,
            "–ì–æ—Å—É—Å–ª—É–≥–∏": 0,
            "–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ": 0,
            "–ò–Ω–æ–µ": 0,
            "–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ": 0,
            "–°–æ—Ü. –∑–∞—â–∏—Ç–∞": 0,
            "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": 0,
            "–ñ–ö–•": 0,
            "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞": 0,
            "–°–í–û, –º–æ–±–∏–ª–∏–∑–∞—Ü–∏—è": 0,
            "–ú—É—Å–æ—Ä": 0,
            "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å": 0,
            "–°/—Ö –∏ –æ—Ö–æ—Ç–∞": 0,
            "–°–≤—è–∑—å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã": 0,
            "–ö—É–ª—å—Ç—É—Ä–∞": 0,
            "–≠–∫–æ–Ω–æ–º–∏–∫–∞": 0,
            "–≠–∫–æ–ª–æ–≥–∏—è, –Ω–µ–¥—Ä–∞, –ª–µ—Å—Ö–æ–∑": 0,
            "–§–∏–∑. –∫—É–ª—å—Ç—É—Ä–∞ –∏ —Å–ø–æ—Ä—Ç": 0,
            "–¢—Ä—É–¥ –∏ –∑–∞–Ω—è—Ç–æ—Å—Ç—å": 0,
            "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ": 0,
            "–û–±—â- –ø–æ–ª–∏—Ç.–≤–æ–ø—Ä–æ—Å—ã": 0,
            "–¢—É—Ä–∏–∑–º": 0,
            "–ü–ª–∞–Ω–µ—Ä–∫–∞": 0
        }

        for row in week_data:
            if len(row) >= 3 and row[2]:  # –ö–∞—Ç–µ–≥–æ—Ä–∏—è –≤ –∫–æ–ª–æ–Ω–∫–µ C
                category = row[2]
                if category in stats:
                    stats[category] += 1

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        stats_row = [
            current_week["display"],
            stats["–í—Å–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π"],
            stats["–î–æ—Ä–æ–≥–∏"],
            stats["–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç"],
            stats["–ì–æ—Å—É—Å–ª—É–≥–∏"],
            stats["–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"],
            stats["–ò–Ω–æ–µ"],
            stats["–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ"],
            stats["–°–æ—Ü. –∑–∞—â–∏—Ç–∞"],
            stats["–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"],
            stats["–ñ–ö–•"],
            stats["–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞"],
            stats["–°–í–û, –º–æ–±–∏–ª–∏–∑–∞—Ü–∏—è"],
            stats["–ú—É—Å–æ—Ä"],
            stats["–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"],
            stats["–°/—Ö –∏ –æ—Ö–æ—Ç–∞"],
            stats["–°–≤—è–∑—å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã"],
            stats["–ö—É–ª—å—Ç—É—Ä–∞"],
            stats["–≠–∫–æ–Ω–æ–º–∏–∫–∞"],
            stats["–≠–∫–æ–ª–æ–≥–∏—è, –Ω–µ–¥—Ä–∞, –ª–µ—Å—Ö–æ–∑"],
            stats["–§–∏–∑. –∫—É–ª—å—Ç—É—Ä–∞ –∏ —Å–ø–æ—Ä—Ç"],
            stats["–¢—Ä—É–¥ –∏ –∑–∞–Ω—è—Ç–æ—Å—Ç—å"],
            stats["–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ"],
            stats["–û–±—â- –ø–æ–ª–∏—Ç.–≤–æ–ø—Ä–æ—Å—ã"],
            stats["–¢—É—Ä–∏–∑–º"],
            stats["–ü–ª–∞–Ω–µ—Ä–∫–∞"]
        ]

        # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        all_data = sheet.get_all_values()
        stats_row_index = find_or_create_stats_row(sheet, all_data, current_week["display"])

        if stats_row_index:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            for j, value in enumerate(stats_row):
                if value > 0 or j < 2:  # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–∏–æ–¥ –∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –¥–∞–∂–µ –µ—Å–ª–∏ 0
                    sheet.update_cell(stats_row_index, 7 + j, value)

        logger.info(f"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞ {current_week['display']}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
def find_or_create_stats_row(sheet, all_data, week_display):
    # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏
    for i, row in enumerate(all_data):
        if len(row) > 6 and row[6] == week_display:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–æ–Ω–∫—É G —Å –ø–µ—Ä–∏–æ–¥–æ–º
            return i + 1  # +1 –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ gspread –Ω—É–º–µ—Ä–∞—Ü–∏—è —Å 1

    # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ –∫–æ–Ω—Ü–µ
    next_row = len(all_data) + 1
    return next_row

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (—á–µ—Ç–≤–µ—Ä–≥-—Å—Ä–µ–¥–∞)
def get_current_week_range():
    today = datetime.now()

    # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–µ—Ç–≤–µ—Ä–≥
    days_since_thursday = (today.weekday() - 3) % 7
    last_thursday = today - timedelta(days=days_since_thursday)
    start_of_week = last_thursday.replace(hour=0, minute=1, second=0, microsecond=0)

    # –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â—É—é —Å—Ä–µ–¥—É
    next_wednesday = start_of_week + timedelta(days=6)
    end_of_week = next_wednesday.replace(hour=23, minute=59, second=59, microsecond=0)

    return {
        "start": start_of_week,
        "end": end_of_week,
        "display": f"{start_of_week.strftime('%d.%m')}-{end_of_week.strftime('%d.%m.%Y')}"
    }

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –¥–∞—Ç–∞ –≤ –Ω–µ–¥–µ–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
def is_date_in_week_range(date, week_range):
    return week_range["start"] <= date <= week_range["end"]

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Ä–∞–π–æ–Ω–æ–≤
def district_keyboard():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=3)

    # –í—Å–µ —Ä–∞–π–æ–Ω—ã –∏–∑ —Å–ø–∏—Å–∫–∞
    districts = [
        "–ö–∞–±–∞–Ω—Å–∫–∏–π", "–ó–∞–∫–∞–º–µ–Ω—Å–∫–∏–π", "–ë–∏—á—É—Ä—Å–∫–∏–π",
        "–ö—è—Ö—Ç–∏–Ω—Å–∫–∏–π", "–ú—É–π—Å–∫–∏–π", "–ö—É—Ä—É–º–∫–∞–Ω—Å–∫–∏–π",
        "–ú—É—Ö–æ—Ä—à–∏–±–∏—Ä—Å–∫–∏–π", "–¢–∞—Ä–±–∞–≥–∞—Ç–∞–π—Å–∫–∏–π", "–¢—É–Ω–∫–∏–Ω—Å–∫–∏–π",
        "–û–∫–∏–Ω—Å–∫–∏–π", "–°–µ–ª–µ–Ω–≥–∏–Ω—Å–∫–∏–π", "–î–∂–∏–¥–∏–Ω—Å–∫–∏–π",
        "–•–æ—Ä–∏–Ω—Å–∫–∏–π", "–ö–∏–∂–∏–Ω–≥–∏–Ω—Å–∫–∏–π", "–ò–≤–æ–ª–≥–∏–Ω—Å–∫–∏–π",
        "–ó–∞–∏–≥—Ä–∞–µ–≤—Å–∫–∏–π", "–ü—Ä–∏–±–∞–π–∫–∞–ª—å—Å–∫–∏–π", "–ë–∞—Ä–≥—É–∑–∏–Ω—Å–∫–∏–π",
        "–ë–∞—É–Ω—Ç–æ–≤—Å–∫–∏–π", "–ï—Ä–∞–≤–Ω–∏–Ω—Å–∫–∏–π", "–≥.–°–µ–≤–µ—Ä–æ–±–∞–π–∫–∞–ª—å—Å–∫",
        "–°–µ–≤–µ—Ä–æ-–ë–∞–π–∫–∞–ª—å—Å–∫–∏–π", "–ù–ê –ü–õ–ê–ù–ï–†–ö–£ –ì–õ–ê–í–´"
    ]

    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ä–∞–π–æ–Ω–æ–≤
    buttons = [types.KeyboardButton(district) for district in districts]

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É (–ø–æ 3 –≤ —Ä—è–¥)
    for i in range(0, len(buttons), 3):
        markup.add(*buttons[i:i + 3])

    return markup

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–æ–±–ª–µ–º
def category_keyboard():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=3)

    # –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ —Å–ø–∏—Å–∫–∞
    categories = [
        "–î–æ—Ä–æ–≥–∏", "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–ì–æ—Å—É—Å–ª—É–≥–∏",
        "–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", "–ò–Ω–æ–µ", "–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ",
        "–°–æ—Ü. –∑–∞—â–∏—Ç–∞", "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ", "–ñ–ö–•",
        "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞", "–°–í–û, –º–æ–±–∏–ª–∏–∑–∞—Ü–∏—è", "–ú—É—Å–æ—Ä",
        "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å", "–°/—Ö –∏ –æ—Ö–æ—Ç–∞", "–°–≤—è–∑—å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã",
        "–ö—É–ª—å—Ç—É—Ä–∞", "–≠–∫–æ–Ω–æ–º–∏–∫–∞", "–≠–∫–æ–ª–æ–≥–∏—è, –Ω–µ–¥—Ä–∞, –ª–µ—Å—Ö–æ–∑",
        "–§–∏–∑. –∫—É–ª—å—Ç—É—Ä–∞ –∏ —Å–ø–æ—Ä—Ç", "–¢—Ä—É–¥ –∏ –∑–∞–Ω—è—Ç–æ—Å—Ç—å", "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ",
        "–û–±—â- –ø–æ–ª–∏—Ç.–≤–æ–ø—Ä–æ—Å—ã", "–¢—É—Ä–∏–∑–º"
    ]

    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    buttons = [types.KeyboardButton(category) for category in categories]

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É (–ø–æ 3 –≤ —Ä—è–¥)
    for i in range(0, len(buttons), 3):
        markup.add(*buttons[i:i + 3])

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä—è–¥
    button_back = types.KeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —Ä–∞–π–æ–Ω–∞")
    markup.add(button_back)

    return markup

@bot.message_handler(commands=['start'])
def send_welcome(message):
    user_data[message.chat.id] = {}  # —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    bot.send_message(
        message.chat.id,
        f"{message.from_user.first_name}, –í–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –ë—É—Ä—è—Ç–∏—è-–∏–Ω—Ñ–æ.24/7. –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω —Ä–µ—Å–ø—É–±–ª–∏–∫–∏",
        parse_mode="HTML",
        reply_markup=district_keyboard()
    )

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—ã—á–Ω—ã—Ö —Ä–∞–π–æ–Ω–æ–≤ (–±–µ–∑ "–ù–ê –ü–õ–ê–ù–ï–†–ö–£ –ì–õ–ê–í–´")
ordinary_districts = [
    "–ö–∞–±–∞–Ω—Å–∫–∏–π", "–ó–∞–∫–∞–º–µ–Ω—Å–∫–∏–π", "–ë–∏—á—É—Ä—Å–∫–∏–π", "–ö—è—Ö—Ç–∏–Ω—Å–∫–∏–π", "–ú—É–π—Å–∫–∏–π",
    "–ö—É—Ä—É–º–∫–∞–Ω—Å–∫–∏–π", "–ú—É—Ö–æ—Ä—à–∏–±–∏—Ä—Å–∫–∏–π", "–¢–∞—Ä–±–∞–≥–∞—Ç–∞–π—Å–∫–∏–π", "–¢—É–Ω–∫–∏–Ω—Å–∫–∏–π",
    "–û–∫–∏–Ω—Å–∫–∏–π", "–°–µ–ª–µ–Ω–≥–∏–Ω—Å–∫–∏–π", "–î–∂–∏–¥–∏–Ω—Å–∫–∏–π", "–•–æ—Ä–∏–Ω—Å–∫–∏–π", "–ö–∏–∂–∏–Ω–≥–∏–Ω—Å–∫–∏–π",
    "–ò–≤–æ–ª–≥–∏–Ω—Å–∫–∏–π", "–ó–∞–∏–≥—Ä–∞–µ–≤—Å–∫–∏–π", "–ü—Ä–∏–±–∞–π–∫–∞–ª—å—Å–∫–∏–π", "–ë–∞—Ä–≥—É–∑–∏–Ω—Å–∫–∏–π",
    "–ë–∞—É–Ω—Ç–æ–≤—Å–∫–∏–π", "–ï—Ä–∞–≤–Ω–∏–Ω—Å–∫–∏–π", "–≥.–°–µ–≤–µ—Ä–æ–±–∞–π–∫–∞–ª—å—Å–∫", "–°–µ–≤–µ—Ä–æ-–ë–∞–π–∫–∞–ª—å—Å–∫–∏–π"
]

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –æ–±—ã—á–Ω—ã—Ö —Ä–∞–π–æ–Ω–æ–≤
@bot.message_handler(func=lambda message: message.text in ordinary_districts)
def handle_district(message):
    user_id = message.chat.id
    district = message.text

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–π–æ–Ω
    if user_id not in user_data:
        user_data[user_id] = {}
    user_data[user_id]['district'] = district

    bot.send_message(
        message.chat.id,
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏ —Ä–∞–π–æ–Ω: <b>{district}</b>\n\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø—Ä–æ–±–ª–µ–º—ã:",
        parse_mode="HTML",
        reply_markup=category_keyboard()
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–ê –ü–õ–ê–ù–ï–†–ö–£ –ì–õ–ê–í–´" - —Å—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç
@bot.message_handler(func=lambda message: message.text == "–ù–ê –ü–õ–ê–ù–ï–†–ö–£ –ì–õ–ê–í–´")
def handle_plannerka(message):
    user_id = message.chat.id
    district = message.text

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–∞–π–æ–Ω –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–ü–ª–∞–Ω–µ—Ä–∫–∞"
    if user_id not in user_data:
        user_data[user_id] = {}
    user_data[user_id]['district'] = district
    user_data[user_id]['category'] = "–ü–ª–∞–Ω–µ—Ä–∫–∞"

    bot.send_message(
        message.chat.id,
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏: <b>{district}</b>\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ:",
        parse_mode="HTML",
        reply_markup=types.ReplyKeyboardRemove()  # –£–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    )
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –æ–∂–∏–¥–∞–µ–º —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è
    user_data[user_id]['waiting_for_text'] = True

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
@bot.message_handler(func=lambda message: message.text in [
    "–î–æ—Ä–æ–≥–∏", "–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–ì–æ—Å—É—Å–ª—É–≥–∏", "–ë–ª–∞–≥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", "–ò–Ω–æ–µ",
    "–ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ", "–°–æ—Ü. –∑–∞—â–∏—Ç–∞", "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ", "–ñ–ö–•", "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞",
    "–°–í–û, –º–æ–±–∏–ª–∏–∑–∞—Ü–∏—è", "–ú—É—Å–æ—Ä", "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å", "–°/—Ö –∏ –æ—Ö–æ—Ç–∞",
    "–°–≤—è–∑—å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã", "–ö—É–ª—å—Ç—É—Ä–∞", "–≠–∫–æ–Ω–æ–º–∏–∫–∞",
    "–≠–∫–æ–ª–æ–≥–∏—è, –Ω–µ–¥—Ä–∞, –ª–µ—Å—Ö–æ–∑", "–§–∏–∑. –∫—É–ª—å—Ç—É—Ä–∞ –∏ —Å–ø–æ—Ä—Ç", "–¢—Ä—É–¥ –∏ –∑–∞–Ω—è—Ç–æ—Å—Ç—å",
    "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ", "–û–±—â- –ø–æ–ª–∏—Ç.–≤–æ–ø—Ä–æ—Å—ã", "–¢—É—Ä–∏–∑–º"
])
def handle_category(message):
    user_id = message.chat.id
    category = message.text

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–±—Ä–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–π–æ–Ω —Ä–∞–Ω–µ–µ
    if user_id not in user_data or 'district' not in user_data[user_id]:
        bot.send_message(
            message.chat.id,
            "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω!",
            reply_markup=district_keyboard()
        )
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    user_data[user_id]['category'] = category

    # –ü—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è
    bot.send_message(
        message.chat.id,
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: <b>{category}</b>\n\n–¢–µ–ø–µ—Ä—å –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ:",
        parse_mode="HTML",
        reply_markup=types.ReplyKeyboardRemove()  # –£–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
    )
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –æ–∂–∏–¥–∞–µ–º —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è
    user_data[user_id]['waiting_for_text'] = True

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
@bot.message_handler(func=lambda message: message.text == "‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —Ä–∞–π–æ–Ω–∞")
def handle_back(message):
    user_id = message.chat.id

    # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id in user_data:
        user_data[user_id] = {}

    bot.send_message(
        message.chat.id,
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω —Ä–µ—Å–ø—É–±–ª–∏–∫–∏:",
        reply_markup=district_keyboard()
    )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@bot.message_handler(func=lambda message: True, content_types=['text'])
def handle_user_text(message):
    user_id = message.chat.id

    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
    if message.text == "‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —Ä–∞–π–æ–Ω–∞":
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id in user_data and user_data[user_id].get('waiting_for_text'):
        user_text = message.text

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –∏ –≤—Ä–µ–º—è
        user_data[user_id]['user_text'] = user_text
        user_data[user_id]['timestamp'] = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Google –¢–∞–±–ª–∏—Ü—É
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ª–∏—Å—Ç (—Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
            sheet = get_current_sheet()

            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ (—Ç–æ–ª—å–∫–æ 4 –∫–æ–ª–æ–Ω–∫–∏)
            row_data = [
                user_data[user_id]['timestamp'],  # –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è - –∫–æ–ª–æ–Ω–∫–∞ A
                user_data[user_id]['district'],  # —Ä–∞–π–æ–Ω - –∫–æ–ª–æ–Ω–∫–∞ B
                user_data[user_id]['category'],  # –∫–∞—Ç–µ–≥–æ—Ä–∏—è - –∫–æ–ª–æ–Ω–∫–∞ C
                user_data[user_id]['user_text']  # —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è - –∫–æ–ª–æ–Ω–∫–∞ D
            ]

            # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É
            success = safe_append_row(sheet, row_data)

            if success:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–ª–µ –∑–∞–ø–∏—Å–∏ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
                try:
                    update_statistics(sheet)
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                bot.send_message(
                    message.chat.id,
                    f"‚úÖ <b>–°–ø–∞—Å–∏–±–æ! –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∞–Ω–æ.</b>\n\n"
                    f"<b>–†–∞–π–æ–Ω:</b> {user_data[user_id]['district']}\n"
                    f"<b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</b> {user_data[user_id]['category']}\n"
                    f"<b>–í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ:</b> {user_data[user_id]['user_text']}\n"
                    f"<b>–í—Ä–µ–º—è:</b> {user_data[user_id]['timestamp']}\n\n"
                    f"–î–ª—è –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω:",
                    parse_mode="HTML",
                    reply_markup=district_keyboard()
                )
            else:
                raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É")

            # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–ø–∏—Å–∏
            if user_id in user_data:
                del user_data[user_id]

        except Exception as e:
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            bot.send_message(
                message.chat.id,
                f"‚ùå <b>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö:</b>\n{str(e)}\n\n"
                f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑, –≤—ã–±—Ä–∞–≤ —Ä–∞–π–æ–Ω:",
                parse_mode="HTML",
                reply_markup=district_keyboard()
            )
            # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            if user_id in user_data:
                del user_data[user_id]

    else:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞–ª —Ç–µ–∫—Å—Ç –±–µ–∑ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        bot.send_message(
            message.chat.id,
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ–±—Ä–∞—â–µ–Ω–∏—è.",
            reply_markup=district_keyboard()
        )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(content_types=['photo', 'video', 'document', 'audio', 'sticker'])
def handle_other_messages(message):
    bot.send_message(
        message.chat.id,
        "–Ø –º–æ–≥—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –æ–±—Ä–∞—â–µ–Ω–∏—è.",
        reply_markup=district_keyboard()
    )

# ================== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==================
if __name__ == "__main__":
    logger.info("üöÄ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    logger.info(f"üìä –¢–∞–±–ª–∏—Ü–∞: {os.environ.get('SPREADSHEET_NAME', 'google-api-sheets-incident')}")
    
    try:
        # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π polling —Å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
        while True:
            try:
                logger.info("üîÑ –ó–∞–ø—É—Å–∫ polling...")
                bot.polling(none_stop=True, interval=0, timeout=20)
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ polling: {e}")
                logger.info("‚è≥ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...")
                import time
                time.sleep(5)
    except KeyboardInterrupt:
        logger.info("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
